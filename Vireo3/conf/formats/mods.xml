<?xml version="1.0" encoding="utf-8" standalone="no"?>
*{
    This is the Metadata Object Description Schema (MODS) export format. It
    encompasses a submissions metadata in the mods schema according to the
    profile generated by the TDL metadata working group.

    http://www.tdl.org/Fwp-content/uploads/2009/04/tdl-descriptive-metadata-guidelines-for-etd-v1.pdf

}*
<mods xmlns="http://www.loc.gov/mods/v3"
    xmlns:etd="http://www.ndltdl.org/standards/metadata/etdms/1.0/">
    #{if sub.getDocumentTitle() != null }
    %{
        def title = sub.getDocumentTitle();
        def subTitle = null;
        if (title.lastIndexOf(":") > 0)
            subTitle = title.substring(title.lastIndexOf(":"),title.length());
    }% 
    <titleInfo>
        <title>${ title?.escapeXml()?.raw() }</title>
        #{if subTitle != null} 
        <subTitle>${subTitle}</subTitle>
        #{/if} 
    </titleInfo>
    #{/if} 
    
    <name type="personal">
        <roleTerm authority="marcrelator" type="text">Author</roleTerm>
        #{if sub.getStudentFirstName() != null} 
        <namePart type="given">${ sub.getStudentFirstName()?.escapeXml()?.raw() }</namePart>
        #{/if}
        #{if sub.getStudentLastName() != null} 
        <namePart type="family">${ sub.getStudentLastName()?.escapeXml()?.raw() }</namePart>
        #{/if} 
    </name>
    
    #{list items:sub.getCommitteeMembers(), as:'member'}
    #{if member.hasRole("Chair","Co-Chair","Supervisor","Co-Supervisor","Advisor") }
    <name type="personal">
        <roleterm authority="marcrelator" type="text">Thesis advisor</roleterm>
        #{if member.getFirstName() != null} 
        <namePart type="given">${ member.getFirstName()?.escapeXml()?.raw() }</namePart>
        #{/if}
        #{if member.getLastName() != null} 
        <namePart type="family">${ member.getLastName()?.escapeXml()?.raw() }</namePart>
        #{/if} 
    </name>
    #{/if}
    #{elseif member.hasNoRole() }
    <name type="personal">
        <roleterm authority="marcrelator" type="text">Committee member</roleterm>
        #{if member.getFirstName() != null} 
        <namePart type="given">${ member.getFirstName()?.escapeXml()?.raw() }</namePart>
        #{/if}
        #{if member.getLastName() != null} 
        <namePart type="family">${ member.getLastName()?.escapeXml()?.raw() }</namePart>
        #{/if} 
    </name>
    #{/elseif}
    #{/list}
    
    #{ if settingRepo.getConfigValue(org.tdl.vireo.constant.AppConfig.GRANTOR) != null } 
    <name type="corporate" authority="lcnaf">
        <roleterm authority="marcrelator" type="text">Degree Grantor</roleterm>
        <namePart>${ settingRepo.getConfigValue(org.tdl.vireo.constant.AppConfig.GRANTOR)?.escapeXml()?.raw() }</namePart>
        <namePart>English</namePart>
    </name>
    #{/if}
    
    <typeOfResource>text</typeOfResource>
    
    <genre authority="marcgt">thesis</genre>
    
    #{if sub.getSubmissionDate() != null || sub.getGraduationYear() != null} 
    <originInfo>
        #{if sub.getSubmissionDate() != null} 
        <dateCreated encoding="iso8601">${ sub.getSubmissionDate().format("yyyy-MM-dd'T'HH:mm:ssZ") }</dateCreated>
        #{/if}
        #{if sub.getGraduationYear() != null}
        %{
	        def graduationDate = sub.getGraduationYear();
	        if (sub.getGraduationMonth() != null) {
	            graduationDate += "-";
	            graduationDate += sub.getGraduationMonth()+1;
	        }
        }% 
        <dateIssued encoding="iso8601">${ graduationDate }</dateIssued>
        #{/if} 
    </originInfo>
    #{/if}
    
    #{if sub.getDocumentLanguage() != null }
    %{
        // Convert to 3 letter language code.
        def iso639 = null;
        try {
            Locale locale = org.apache.commons.lang.LocaleUtils.toLocale(sub.getDocumentLanguage());
            iso639 = locale.getISO3Language();
        } catch (RuntimeException re) { /* ignore */ }
    }%
    <language>
    
        <languageTerm type="code" authority="iso639-2b">${ iso639 }</languageTerm>
    </language>
    #{/if}
    
    <physicalDescription>
        <form authority="marcform">electronic</form>
        #{if sub.getPrimaryDocument() != null } 
        <internetMediaType>${ sub.getPrimaryDocument().getMimeType()?.escapeXml()?.raw() }</internetMediaType>
        #{/if} 
        <digitalOrigin>born digital</digitalOrigin>
    </physicalDescription>
    
    #{if sub.getDocumentAbstract() != null } 
    <abstract lang="eng">${ sub.getDocumentAbstract()?.escapeXml()?.raw() }</abstract>
    #{/if}
    
    #{if sub.getDocumentKeywords() != null } 
    <subject>
	    #{list items:sub.getDocumentKeywords().split(";"), as:'keyword'} 
	    <topic>${ keyword.trim()?.escapeXml()?.raw() }</topic>
	    #{/list} 
    </subject>
    #{/if} 
    
    #{if sub.getDepositId() != null } 
    <identifier type="hdl">${ sub.getDepositId()?.escapeXml()?.raw() }</identifier>
    
    <location>
        <url>${ sub.getDepositId()?.escapeXml()?.raw() }</url>
    </location>
    #{/if}
    
    #{if sub.getDegree() != null || sub.getDegreeLevel() != null || sub.getMajor() != null} 
    <extension>
        <etd:degree>
            #{if sub.getDegree() != null } 
            <etd:name>${ sub.getDegree()?.escapeXml()?.raw() }</etd:name>
            #{/if}
            #{if sub.getDegreeLevel() != null } 
            <etd:level>${ sub.getDegreeLevel().name().toLowerCase().capitalizeWords()?.escapeXml()?.raw() }</etd:level>
            #{/if}
            #{if sub.getMajor() != null } 
            <etd:discipline>${ sub.getMajor()?.escapeXml()?.raw() }</etd:discipline>
            #{/if} 
        </etd:degree> 
    </extension>
    #{/if}
    
    <recordInfo>
        <recordContentStore authority="marcorg">TxCM</recordContentStore>
        <recordCreationDate encoding="iso8601">${ new java.util.Date().format("yyyy-MM-dd'T'HH:mm:ssZ") }</recordCreationDate>
        <recordIdentifier>${ sub.getId() }</recordIdentifier>
    </recordInfo>

</mods>